language: dart
branches:
  only:
  - master
  # Semantic version tags and legacy branches of the form "1.2.x".
  - "/^\\d+\\.\\d+\\.(\\d+([+-].*)?|x)$/"

cache:
  directories:
  - $HOME/.pub-cache

env:
  global:
  - PROTOBUF_VERSION=3.10.1
  - PATH="$HOME/protoc/bin:$PATH"

before_install:
- if [[ "$TRAVIS_OS_NAME" = windows ]]; then
    curl -Lo protoc.zip https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOBUF_VERSION}/protoc-${PROTOBUF_VERSION}-win64.zip;
  else
    curl -Lo protoc.zip https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOBUF_VERSION}/protoc-${PROTOBUF_VERSION}-${TRAVIS_OS_NAME}-x86_64.zip;
  fi
- unzip -d "$HOME/protoc" protoc.zip

before_script:
- pub run grinder protobuf
# Format the generated code or else the formatter task will get upset.
- dartfmt -w --fix lib/src/embedded_sass.pb*
- pub run grinder pkg-standalone-dev

jobs:
  include:

  ## Testing

  - dart: stable
    dart_task: test
  # TODO(nweiz): Enable this when dart-lang/pub#2545 is fixed.
  # - dart: dev
  #   dart_task: test
  - dart: stable
    os: windows
    dart_task: test
  - dart: stable
    os: osx
    dart_task: test

  # Static checks
  - dart_task: {dartanalyzer: --fatal-warnings ./}
  - dart_task: dartfmt

  ## Deploying

  # Deploy Linux releases to GitHub. Mac OS and Windows releases are deployed in
  # a later stage so that we can build native snapshots on bots with the same
  # operating system.
  - stage: deploy 1
    name: "GitHub: Linux"
    if: &deploy-if
      (type IN (push, api)) AND (repo = sass/dart-sass-embedded) AND tag =~ ^\d+\.\d+\.\d+([+-].*)?$
    env: &github-env
      - GITHUB_USER=sassbot
      # GITHUB_TOKEN="..."
      #
      # Note that this overrides the read-only auth token that's set for all
      # builds.
      - secure: "l3q6m5Khk+E/UrzZzk2htn9YC6TuUJ3hDR6Ug28zeIf7+bV3/BbjgsOMP556H9p9q+9E3N4mKMeTApdaU5y1TjJZYLaYJETqHiYZDXJ0f1/2IzPOh+5OIqVF3pFhdc6GvmDG/d6b4bBCh9njvKIvWS51ej9VuizRfQI3BMRuApgmjBVkV2MM13HEhQ3dbe5856Gf00LvP6UF9o+bnIRo/udhmpYGQsEHLdrq2JgawiRylyLzW+hIfhS7wJm/JS32wV8sLJo70NCD5W74ZPmDv0zOKkX2VFbFv7y2qBmgUX8f8d8KqNVOzYEu8UTd3kIQASdOenZfg76S74EjW7o7QbLfJB8h0/BVMEhA/yaVuye2vu76ihGELAunSNvx7zlU16Z4TT7z+YSwCni7jvzWJajTiLoQXygHxJLEEjbBN/qF6gyre07g+zbBTXPIBvwm8lMqtyekbbq7sosL7/ctU4sX7qbuYaxhRvMhaZtkzS2clZajp2SFagTZvitbMNT5HE9YJTrNMgoEP7aiELAfmc02xUzNfaZ15x9G3n3RisTmkrwdLD6We2L0aPa+2LiyiBNbxH3QqyfcIMyXbDnymuphkYXq+fL3W7x0G9ZmtjWBB9tUcNe2VlD5hBhPShYbDwZKbKn9EgXHOnmZ/04ARyJbnQGUYKlZR5U2HGon7HU="
    script: skip # Don't run tests
    deploy:
      provider: script
      script: pub run grinder pkg-github-release pkg-github-linux
      skip_cleanup: true # Don't clean up the Dart SDK.

      # This causes the deploy to only be build when a tag is pushed. This
      # is because the `tag` attribute in `if:` statements has a different
      # understanding of the "current tag" than this, which uses the
      # `TRAVIS_TAG` environment variable. `if:` statements check whether a
      # tag exists that refers to the current commit, whereas `TRAVIS_TAG`
      # checks whether the current build was caused by a tag.
      #
      # We check `if:` because it avoids unnecessary build steps, and
      # `on: {tags: true}` ensures that we only deploy on the build caused
      # by pushing a tag, not the build caused by pushing master.
      on: {tags: true}

  # Deploy to Bazel. This is in a separate deploy stage because it needs to
  # install the npm package.
  - stage: deploy 2
    name: "GitHub: Mac OS"
    if: *deploy-if
    env: *github-env
    script: skip
    os: osx
    deploy:
      provider: script
      script: pub run grinder pkg-github-macos
      skip_cleanup: true
      on: {tags: true}

  - name: "GitHub: Windows"
    if: *deploy-if
    env: *github-env
    script: skip
    deploy:
      provider: script
      script: pub run grinder pkg-github-windows
      skip_cleanup: true
      on: {tags: true}
